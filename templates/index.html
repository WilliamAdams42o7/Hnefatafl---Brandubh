<!DOCTYPE html>
<html>
<head>
    <title>Hnefatafl</title>
    <style>
        table { border-collapse: collapse; margin: 20px auto; }
        td {
            width: 60px;
            height: 60px;
            border: 1px solid #333;
            text-align: center;
            vertical-align: middle;
        }
        td.light { background-color: #deb887; } /* L_BROWN */
        td.dark { background-color: #85542a; }   /* D_BROWN */
        #status { text-align: center; font-size: 20px; margin-top: 20px; }
        #mode-buttons { text-align: center; margin: 20px; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <div id="mode-buttons">
        <button onclick="startGame('PvP')">Player vs Player</button>
        <button onclick="startGame('PvAI')">Player vs AI</button>
        <button onclick="startGame('AIvP')">AI vs Player</button>
        <button onclick="startGame('AIvAI')">AI vs AI</button>
    </div>

    <div id="status"></div>
    <table id="board"></table>

    <script>
        const SPECIAL_SQUARES = [[3,3],[0,0],[0,6],[6,0],[6,6]]; // throne + corners
        let selected = null;
        let gameOver = false;

        function startGame(mode) {
            fetch('/start_game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode })
            })
            .then(response => response.json())
            .then(data => {
                selected = null;
                gameOver = false;
                renderBoard(data.board);
                document.getElementById('status').innerText = "Game started: " + mode;
            });
        }

        function renderBoard(board) {
            const table = document.getElementById('board');
            table.innerHTML = '';
            board.forEach((row, r) => {
                const tr = document.createElement('tr');
                row.forEach((cell, c) => {
                    const td = document.createElement('td');
                    td.dataset.row = r;
                    td.dataset.col = c;
                    td.classList.add((r + c) % 2 === 0 ? 'light' : 'dark');

                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("width", "50");
                    svg.setAttribute("height", "50");

                    // Draw cross under piece for throne/corners
                    if (SPECIAL_SQUARES.some(pos => pos[0] === r && pos[1] === c)) {
                        const crossSize = 45;
                        const offset = 25;
                        const line1 = document.createElementNS("http://www.w3.org/2000/svg","line");
                        line1.setAttribute("x1", offset - crossSize/2);
                        line1.setAttribute("y1", offset - crossSize/2);
                        line1.setAttribute("x2", offset + crossSize/2);
                        line1.setAttribute("y2", offset + crossSize/2);
                        line1.setAttribute("stroke","black");
                        line1.setAttribute("stroke-width",2);
                        svg.appendChild(line1);

                        const line2 = document.createElementNS("http://www.w3.org/2000/svg","line");
                        line2.setAttribute("x1", offset + crossSize/2);
                        line2.setAttribute("y1", offset - crossSize/2);
                        line2.setAttribute("x2", offset - crossSize/2);
                        line2.setAttribute("y2", offset + crossSize/2);
                        line2.setAttribute("stroke","black");
                        line2.setAttribute("stroke-width",2);
                        svg.appendChild(line2);
                    }

                    // Draw piece if present
                    if (cell) {
                        const topY = 20;
                        const bottomY = 28;
                        const cx = 25;
                        const rx = 20;
                        const ry = 10;
                        const fillColor = cell.is_king ? "#009999" : (cell.team === "attacker" ? "#ff6666" : "#66cccc");
                        const sideColor = cell.is_king ? "#007777" : (cell.team === "attacker" ? "#cc0000" : "#339999");

                        // bottom ellipse
                        const bottom = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                        bottom.setAttribute("cx", cx);
                        bottom.setAttribute("cy", bottomY);
                        bottom.setAttribute("rx", rx);
                        bottom.setAttribute("ry", ry);
                        bottom.setAttribute("fill", sideColor);
                        bottom.setAttribute("stroke", "black");
                        bottom.setAttribute("stroke-width", 1);
                        svg.appendChild(bottom);

                        // vertical lines
                        const leftLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        leftLine.setAttribute("x1", cx - rx);
                        leftLine.setAttribute("y1", topY);
                        leftLine.setAttribute("x2", cx - rx);
                        leftLine.setAttribute("y2", bottomY);
                        leftLine.setAttribute("stroke", "black");
                        leftLine.setAttribute("stroke-width", 2);
                        svg.appendChild(leftLine);

                        const rightLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        rightLine.setAttribute("x1", cx + rx);
                        rightLine.setAttribute("y1", topY);
                        rightLine.setAttribute("x2", cx + rx);
                        rightLine.setAttribute("y2", bottomY);
                        rightLine.setAttribute("stroke", "black");
                        rightLine.setAttribute("stroke-width", 2);
                        svg.appendChild(rightLine);

                        // top ellipse
                        const top = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                        top.setAttribute("cx", cx);
                        top.setAttribute("cy", topY);
                        top.setAttribute("rx", rx);
                        top.setAttribute("ry", ry);
                        top.setAttribute("fill", fillColor);
                        top.setAttribute("stroke", "black");
                        top.setAttribute("stroke-width", 2);
                        svg.appendChild(top);

                        // king cross
                        if (cell.is_king) {
                            const hLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                            hLine.setAttribute("x1", cx - 10);
                            hLine.setAttribute("y1", topY);
                            hLine.setAttribute("x2", cx + 10);
                            hLine.setAttribute("y2", topY);
                            hLine.setAttribute("stroke", "black");
                            hLine.setAttribute("stroke-width", 3);
                            svg.appendChild(hLine);

                            const vLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                            vLine.setAttribute("x1", cx);
                            vLine.setAttribute("y1", topY - 10);
                            vLine.setAttribute("x2", cx);
                            vLine.setAttribute("y2", topY + 10);
                            vLine.setAttribute("stroke", "black");
                            vLine.setAttribute("stroke-width", 3);
                            svg.appendChild(vLine);
                        }
                    }

                    td.appendChild(svg);
                    td.onclick = () => handleClick(r, c);
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
        }

        function handleClick(row, col) {
            if (gameOver) return;
            if (!selected) {
                selected = [row, col];
            } else {
                const start = selected;
                const end = [row, col];
                selected = null;

                fetch('/make_move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start: start, end: end })
                })
                .then(async response => {
                    const data = await response.json();
                    if (!response.ok) {
                        alert("Move rejected: " + (data.error || "Illegal move"));
                        return;
                    }
                    renderBoard(data.board);

                    if (data.game_over) {
                        gameOver = true;
                        document.getElementById('status').innerText = "Game over! Winner: " + data.winner;
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Connection error.");
                });
            }
        }
    </script>
</body>
</html>
